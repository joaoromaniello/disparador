<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Disparador Moderno</title>
  <link rel="stylesheet" href="/disparo.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <main class="container">
    <header>
      <h1>Disparador</h1>
      <p class="connection-status"><strong>N√∫mero conectado:</strong> <%= numeroConectado %></p>
    </header>
    <a href="/<%= token %>/disparos" target="_blank" class="primary-button" style="margin-bottom: 24px;">
      üìã Visualizar Disparos
    </a>
    <div class="tab-container">
      <nav class="tab-nav">
        <button class="tab-button active" data-tab="texto">Disparo de Texto</button>
        <button class="tab-button" data-tab="midia">Disparo de M√≠dia</button>
      </nav>

      <div class="tab-content">
        <div id="texto" class="tab-pane active">
          <form id="formTexto" class="form-card">
            <input type="hidden" name="token" value="<%= token %>">
            
            <div class="form-group">
                <label for="tipoEnvio">Tipo de Envio</label>
                 <div class="checkbox-control">
                    <input type="checkbox" id="emMassa">
                    <label for="emMassa">Enviar em massa (para m√∫ltiplos contatos)</label>
                </div>
            </div>

            <div class="form-group" id="containerNumeroIndividual">
              <label for="number">N√∫mero Individual (ex: 5534999998888)</label>
              <input type="text" name="number" id="number">
            </div>
            
            <div id="listaNumeros" style="display: none;">
                <p>Selecione os contatos da lista:</p>
                    <div class="checkbox-control">
                      <input type="checkbox" id="selectAllCheckbox">
                      <label for="selectAllCheckbox"><strong>Selecionar todos</strong></label>
                  </div>
                <div class="checkbox-control">
                    <input type="checkbox" class="numeroCheckbox" value="5516992337024">
                    <label>Jo√£o</label>
                </div>
                <div class="checkbox-control">
                    <input type="checkbox" class="numeroCheckbox" value="5534984277746">
                    <label>Maria</label>
                </div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111111">
    <label>Teste 1</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111112">
    <label>Teste 2</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111113">
    <label>Teste 3</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111114">
    <label>Teste 4</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111115">
    <label>Teste 5</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111116">
    <label>Teste 6</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111117">
    <label>Teste 7</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111118">
    <label>Teste 8</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111119">
    <label>Teste 9</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111120">
    <label>Teste 10</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111121">
    <label>Teste 11</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111122">
    <label>Teste 12</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111123">
    <label>Teste 13</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111124">
    <label>Teste 14</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111125">
    <label>Teste 15</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111126">
    <label>Teste 16</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111127">
    <label>Teste 17</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111128">
    <label>Teste 18</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111129">
    <label>Teste 19</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111130">
    <label>Teste 20</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111131">
    <label>Teste 21</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111132">
    <label>Teste 22</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111133">
    <label>Teste 23</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111134">
    <label>Teste 24</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111135">
    <label>Teste 25</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111136">
    <label>Teste 26</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111137">
    <label>Teste 27</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111138">
    <label>Teste 28</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111139">
    <label>Teste 29</label>
</div>
<div class="checkbox-control">
    <input type="checkbox" class="numeroCheckbox" value="5534984111140">
    <label>Teste 30</label>
</div>
            </div>

            <div class="form-group">
                <label for="listaSelect">Usar Mensagem Padr√£o</label>
                <select id="listaSelect">
                    <option value="">-- Escolha uma mensagem r√°pida --</option>
                    <option value="padrao">Padr√£o</option>
                    <option value="bebidas">Bebidas</option>
                    <option value="carnes">Carnes</option>
                </select>
            </div>

            <div class="form-group">
              <label for="text">Mensagem</label>
              <textarea name="text" id="text" required></textarea>
            </div>
            
             <div class="checkbox-control">
                <input type="checkbox" id="agendarEnvio">
                <label for="agendarEnvio">Agendar envio para 1 minuto depois</label>
            </div>

            <button type="submit" class="primary-button" style="margin-top: 24px;">Enviar Mensagem</button>
          </form>
        </div>

        <div id="midia" class="tab-pane">
          <form id="formMidia" class="form-card">
            <input type="hidden" name="token" value="<%= token %>">
            <div class="form-group">
              <label for="numberMidia">N√∫mero (ex: 5534999998888)</label>
              <input type="text" name="number" id="numberMidia" required>
            </div>
            <div class="form-group">
              <label for="fileMidia">URL da Imagem</label>
              <input type="url" name="file" id="fileMidia" required placeholder="https://exemplo.com/imagem.jpg">
            </div>
            <div class="form-group">
              <label for="textMidia">Legenda (opcional)</label>
              <input type="text" name="text" id="textMidia">
            </div>
            <button type="submit" class="primary-button">Enviar M√≠dia</button>
          </form>
        </div>
      </div>
    </div>
  </main>
  
  <div id="toast-container"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // ------------------------------------
  // Sistema de Notifica√ß√£o (Toast)
  // ------------------------------------
  function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    container.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(120%)';
      setTimeout(() => toast.remove(), 500); // Remove from DOM after animation
    }, 4000);
  }

        const selectAll = document.getElementById('selectAllCheckbox');
      selectAll?.addEventListener('change', function() {
        const allChecks = document.querySelectorAll('.numeroCheckbox');
        allChecks.forEach(cb => cb.checked = selectAll.checked);
      });


  // ------------------------------------
  // L√≥gica das Abas
  // ------------------------------------
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabPanes = document.querySelectorAll('.tab-pane');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      // Desativa todos
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabPanes.forEach(pane => pane.classList.remove('active'));

      // Ativa o clicado
      button.classList.add('active');
      const targetPane = document.getElementById(button.dataset.tab);
      if (targetPane) {
        targetPane.classList.add('active');
      }
    });
  });

  // ------------------------------------
  // L√≥gica do Formul√°rio de Texto
  // ------------------------------------
  const formTexto = document.getElementById('formTexto');
  const listaSelect = document.getElementById('listaSelect');
  const textInput = document.getElementById('text');
  const emMassaCheckbox = document.getElementById('emMassa');
  const listaNumerosDiv = document.getElementById('listaNumeros');
  const numeroIndividualInput = document.getElementById('number');
  const containerNumeroIndividual = document.getElementById('containerNumeroIndividual');

  const listas = {
    padrao: "Ol√°! Confira nossa lista de produtos atualizada!",
    bebidas: "üçπ Lista de Bebidas:\n- Coca-Cola\n- Heineken\n- Schweppes",
    carnes: "ü•© Lista de Carnes:\n- Picanha\n- Fraldinha\n- Costela"
  };

  listaSelect.addEventListener('change', function () {
    const valor = this.value;
    textInput.value = listas[valor] || textInput.value;
  });

  emMassaCheckbox.addEventListener('change', function () {
    const isChecked = this.checked;
    listaNumerosDiv.style.display = isChecked ? 'block' : 'none';
    containerNumeroIndividual.style.display = isChecked ? 'none' : 'block';
    numeroIndividualInput.disabled = isChecked;
    numeroIndividualInput.required = !isChecked;
    if (!isChecked) {
        numeroIndividualInput.value = ''; // Limpa o campo individual ao desmarcar
    }
  });
  
  // Seta o estado inicial
  emMassaCheckbox.dispatchEvent(new Event('change'));

  formTexto.addEventListener('submit', function (e) {
    e.preventDefault();
    const token = formTexto.querySelector('input[name="token"]').value;
    const text = textInput.value;
    const agendar = document.getElementById('agendarEnvio').checked;

    if (emMassaCheckbox.checked) {
      // Envio em massa
      const checkboxes = document.querySelectorAll('.numeroCheckbox:checked');
      const numbers = Array.from(checkboxes).map(cb => cb.value + '@s.whatsapp.net');

      if (numbers.length === 0) {
        return showToast('Selecione pelo menos um n√∫mero para envio em massa.', 'error');
      }

      const payload = {
        numbers,
        type: 'text',
        text,
        delayMin: 5,
        delayMax: 10,
        info: 'disparo-massa'
      };
      
      if (agendar) {
        payload.scheduled_for = Date.now() + 1 * 60 * 1000;
      }
      
      apiRequest('/disparo/massa', { token, payload });

    } else {
      // Envio individual
      const number = numeroIndividualInput.value;
      if (!number) {
        return showToast('Por favor, informe o n√∫mero.', 'error');
      }
      apiRequest('/disparo/texto', { token, number, text });
    }
  });

  // ------------------------------------
  // L√≥gica do Formul√°rio de M√≠dia
  // ------------------------------------
  const formMidia = document.getElementById('formMidia');
  formMidia.addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    apiRequest('/disparo/midia', data);
  });
      
async function apiRequest(endpoint, body) {
  try {
    const res = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const resClone = res.clone();

    let responseData;
    try {
      responseData = await res.json();
    } catch {
      const txt = await resClone.text();
      throw new Error(txt);
    }

    if (responseData.error) {
      throw new Error(responseData.error);
    }

    if (!res.ok) {
      throw new Error(responseData.message || 'Ocorreu um erro no servidor.');
    }

    let successMessage = responseData.message || 'Disparo realizado com sucesso!';
    if (responseData.data && responseData.data.recipient) {
      successMessage += ` Para: ${responseData.data.recipient}`;
    }
    showToast(successMessage, 'success');

  } catch (err) {
    // Mostra mensagem de erro para o usu√°rio
    console.error('Erro na requisi√ß√£o:', err);
    showToast(err.message || 'Erro ao processar a requisi√ß√£o.', 'error');
  }
}


});

</script>

</body>
</html>
